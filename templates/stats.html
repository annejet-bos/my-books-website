{% extends 'base.html' %}

{% block title %}Reading Stats{% endblock %}

{% block content %}
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 class="heading">üìä Reading Statistics</h2>
            <p class="description">Insights into your reading journey</p>
        </div>
    </div>

    <!-- Reading Challenge -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 class="heading">üìö This Year's Progress</h2>
    </div>
     <div class="progress">
        <div class="progress-bar" style="width: {{ progress }}%;"></div>
        <div class="progress-text">{{ read_books }}/{{ goal }}</div>
    </div>


    <!-- Overview Stats -->
    <div class="stats-overview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 40px 0;">
        <div class="stat-card">
            <div class="stat-number" id="totalBooks">{{ books_data|length }}</div>
            <div class="stat-label">Total Books Read</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="avgRating">-</div>
            <div class="stat-label">Average Rating</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalPages">-</div>
            <div class="stat-label">Pages Read</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="readingThisYear">{{ read_books }}</div>
            <div class="stat-label">Books This Year</div>
        </div>
    </div>

    {% if books_data|length > 0 %}
    <!-- Charts -->
    <div class="charts-grid" style="display: flex; flex-direction: column; gap: 40px; margin: 40px 0;">

        <!-- Row 1: Donut Charts -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
            <div class="chart-container">
                <div class="chart-title">üìö Genre Distribution</div>
                <canvas id="genreChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">üìñ Book Length Categories</div>
                <canvas id="pageCategoriesChart"></canvas>
            </div>
        </div>

        <!-- Row 2: Ratings -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
            <div class="chart-container">
                <div class="chart-title">‚≠ê Star Rating Distribution</div>
                <canvas id="starRatingChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">üå∂Ô∏è Spice Rating Distribution</div>
                <canvas id="spiceRatingChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Monthly Reading Trends -->
    <div class="monthly-books">
        <div class="chart-title">üìÖ Monthly Reading Trends</div>
        <div class="chart-container">
            <canvas id="monthlyChart" style="margin-bottom: 20px;"></canvas>
        </div>

        <div id="monthDetails" class="month-books">
            <h4 id="selectedMonth" class="heading" style="font-size: 1.2rem; margin-bottom: 15px;">Selected Month</h4>
            <div id="monthBooksList" class="book-grid"></div>
        </div>
    </div>

     <!-- Generic Details Popup -->
    <div id="detailsPopup" class="details-popup">
        <div class="popup-content">
            <div class="popup-header">
                <h4 id="popupTitle"></h4>
                <button id="closePopup" class="close-btn">&times;</button>
            </div>
            <div id="popupBooksList" class="book-grid"></div>
        </div>
    </div>
    <div id="popupOverlay" class="popup-overlay"></div>

    {% else %}
    <div style="text-align: center; padding: 40px; color: #666;">
        <h3>No books found in your database yet!</h3>
        <p>Start adding and rating books to see your reading statistics.</p>
        <a href="{{ url_for('add') }}" class="button">Add Your First Book</a>
    </div>
    {% endif %}
</div>

<style>
    .stat-card {
        background: linear-gradient(135deg, #ff69b4, #ff1493);
        color: white;
        padding: 25px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
        transition: transform 0.3s ease;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-number { font-size: 2.5em; font-weight: 900; margin-bottom: 5px; }
    .stat-label { font-size: 0.9em; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.1ch; }
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }
    .chart-container:hover { transform: translateY(-2px); }
    .chart-title {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.2em;
        font-weight: 700;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.1ch;
    }
    .chart-title:after {
        display: block;
        content: '';
        width: 40px;
        height: 3px;
        background: linear-gradient(135deg, #ff69b4, #ff1493);
        margin: 10px auto 0;
    }
    .monthly-books {
        margin-top: 40px;
        background: white;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .month-books { display: none; margin-top: 20px; padding: 20px; background: #ecf0f9; border-radius: 8px; }
    .month-book-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #ff69b4;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }
    .month-book-card:hover { transform: translateX(5px); }
    .book-title { font-weight: 700; color: #333; margin-bottom: 5px; }
    .book-author { color: #666; font-size: 0.9em; margin-bottom: 5px; }
    .book-rating { color: #ff1493; font-size: 0.9em; font-weight: 600; }

    /* Popup Styles */
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
        backdrop-filter: blur(4px);
    }

    .details-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        display: none;
        max-width: 80vw;
        max-height: 80vh;
        overflow: hidden;
    }

    .popup-content {
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 25px;
        border-bottom: 1px solid #eee;
        background: linear-gradient(135deg, #ff69b4, #ff1493);
        color: white;
    }

    .popup-header h4 {
        margin: 0;
        font-size: 1.3em;
        font-weight: 700;
    }

    .close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 1.8em;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.3s ease;
    }

    .close-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    .book-grid {
        padding: 25px;
        max-height: 60vh;
        overflow-y: auto;
    }

    .popup-book-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #ff69b4;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .popup-book-card:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(255, 105, 180, 0.2);
    }

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    const books = {{ books_data | tojson | safe }};
    console.log('Books data:', books);

    // Global variables for popup management
    let currentChartData = {};

    function calculateStats(books) {
        if (books.length === 0) return;
        const booksWithRatings = books.filter(b => b.star_rating !== null && b.star_rating !== undefined);
        const avgRating = booksWithRatings.length > 0 ? booksWithRatings.reduce((s, b) => s + b.star_rating, 0) / booksWithRatings.length : 0;
        const booksWithPages = books.filter(b => b.pages && b.pages > 0);
        const totalPages = booksWithPages.reduce((s, b) => s + b.pages, 0);
        document.getElementById('avgRating').textContent = avgRating > 0 ? avgRating.toFixed(1) : 'N/A';
        document.getElementById('totalPages').textContent = totalPages > 0 ? totalPages.toLocaleString() : 'N/A';
    }

    function showPopup(title, books) {
        const popup = document.getElementById('detailsPopup');
        const overlay = document.getElementById('popupOverlay');
        const popupTitle = document.getElementById('popupTitle');
        const booksList = document.getElementById('popupBooksList');

        popupTitle.textContent = title;

        if (books.length === 0) {
            booksList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No books found in this category.</p>';
        } else {
            booksList.innerHTML = books.map(book => `
                <div class="popup-book-card">
                    <div class="book-title">${book.title}</div>
                    <div class="book-author">by ${book.author}</div>
                    <div class="book-rating">‚≠ê ${book.star_rating || 'N/A'} | üå∂Ô∏è ${book.spice_rating || 'N/A'} ${book.pages ? `| üìñ ${book.pages} pages` : ''}</div>
                    ${book.genre ? `<div style="font-size: 0.8em; color: #ff1493; margin-top: 5px;">üìö ${book.genre}</div>` : ''}
                </div>
            `).join('');
        }

        overlay.style.display = 'block';
        popup.style.display = 'block';
    }

    function hidePopup() {
        document.getElementById('detailsPopup').style.display = 'none';
        document.getElementById('popupOverlay').style.display = 'none';
    }

    // Setup popup event listeners
    document.getElementById('closePopup').addEventListener('click', hidePopup);
    document.getElementById('popupOverlay').addEventListener('click', hidePopup);

    Chart.defaults.font.family = '"Nunito Sans", sans-serif';
    Chart.defaults.color = '#333';

    function createGenreChart(books) {
        const genreCounts = {};
        const genreBooks = {};
        books.forEach(b => {
            const g = b.genre && b.genre.trim() !== '' ? b.genre : 'Unknown';
            genreCounts[g] = (genreCounts[g] || 0) + 1;
            if (!genreBooks[g]) genreBooks[g] = [];
            genreBooks[g].push(b);
        });

        currentChartData.genres = genreBooks;

        const ctx = document.getElementById('genreChart').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(genreCounts),
                datasets: [{
                    data: Object.values(genreCounts),
                    backgroundColor: ['#ff69b4','#ff1493','#ff91c7','#ff4da6','#ffa1d6','#ff77c7','#ff5fb8','#ff2e92','#ffadd6','#ff85c7'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const genre = Object.keys(genreCounts)[index];
                        showPopup(`üìö ${genre} Books (${genreCounts[genre]} books)`, genreBooks[genre]);
                    }
                }
            }
        });
    }

    function createPageCategoriesChart(books) {
        const cats = {'‚â§300 pages':0,'301-500 pages':0,'500+ pages':0,'Unknown':0};
        const categoryBooks = {'‚â§300 pages':[],'301-500 pages':[],'500+ pages':[],'Unknown':[]};

        books.forEach(b => {
            if (b.pages > 0) {
                if (b.pages <= 300) {
                    cats['‚â§300 pages']++;
                    categoryBooks['‚â§300 pages'].push(b);
                } else if (b.pages <= 500) {
                    cats['301-500 pages']++;
                    categoryBooks['301-500 pages'].push(b);
                } else {
                    cats['500+ pages']++;
                    categoryBooks['500+ pages'].push(b);
                }
            } else {
                cats['Unknown']++;
                categoryBooks['Unknown'].push(b);
            }
        });

        currentChartData.pageCategories = categoryBooks;

        const ctx = document.getElementById('pageCategoriesChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(cats),
                datasets: [{
                    data: Object.values(cats),
                    backgroundColor: ['#ff91c7','#ff69b4','#ff1493','#ffc0cb'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const category = Object.keys(cats)[index];
                        showPopup(`üìñ ${category} Books (${cats[category]} books)`, categoryBooks[category]);
                    }
                }
            }
        });
    }

    function createStarRatingChart(books) {
        const labels = ['1','1.5','2','2.5','3','3.5','4','4.5','5'];
        const counts = {};
        const ratingBooks = {};

        labels.forEach(l => {
            counts[l] = 0;
            ratingBooks[l] = [];
        });

        books.forEach(b => {
            if (b.star_rating !== null) {
                const r = b.star_rating.toString();
                if (counts.hasOwnProperty(r)) {
                    counts[r]++;
                    ratingBooks[r].push(b);
                }
            }
        });

        currentChartData.starRatings = ratingBooks;

        const ctx = document.getElementById('starRatingChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Books',
                    data: labels.map(l => counts[l]),
                    backgroundColor: '#ff69b4',
                    borderColor: '#ff1493',
                    borderWidth: 2,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {beginAtZero: true, ticks: {stepSize: 1}},
                    x: {grid: {display: false}}
                },
                plugins: {legend: {display: false}},
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const rating = labels[index];
                        showPopup(`‚≠ê ${rating} Star Books (${counts[rating]} books)`, ratingBooks[rating]);
                    }
                }
            }
        });
    }

    function createSpiceRatingChart(books) {
        const labels = ['1','1.5','2','2.5','3','3.5','4','4.5','5'];
        const counts = {};
        const ratingBooks = {};

        labels.forEach(l => {
            counts[l] = 0;
            ratingBooks[l] = [];
        });

        books.forEach(b => {
            if (b.spice_rating !== null) {
                const r = b.spice_rating.toString();
                if (counts.hasOwnProperty(r)) {
                    counts[r]++;
                    ratingBooks[r].push(b);
                }
            }
        });

        currentChartData.spiceRatings = ratingBooks;

        const ctx = document.getElementById('spiceRatingChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Books',
                    data: labels.map(l => counts[l]),
                    backgroundColor: '#ff91c7',
                    borderColor: '#ff4da6',
                    borderWidth: 2,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {beginAtZero: true, ticks: {stepSize: 1}},
                    x: {grid: {display: false}}
                },
                plugins: {legend: {display: false}},
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const rating = labels[index];
                        showPopup(`üå∂Ô∏è ${rating} Spice Rating Books (${counts[rating]} books)`, ratingBooks[rating]);
                    }
                }
            }
        });
    }

    function createMonthlyChart(books) {
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const monthlyData = {}, monthlyBooks = {};
        months.forEach(m => {monthlyData[m] = 0; monthlyBooks[m] = [];});

        const year = new Date().getFullYear();
        books.forEach(b => {
            if (b.date_finished) {
                const d = new Date(b.date_finished + 'T00:00:00');
                if (d.getFullYear() === year) {
                    const m = months[d.getMonth()];
                    monthlyData[m]++;
                    monthlyBooks[m].push(b);
                }
            }
        });

        const ctx = document.getElementById('monthlyChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    label: 'Books Finished',
                    data: Object.values(monthlyData),
                    backgroundColor: '#ff69b4',
                    borderColor: '#ff1493',
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                onClick: (e, els) => {
                    if (els.length > 0) {
                        const i = els[0].index;
                        showMonthDetails(months[i], monthlyBooks[months[i]]);
                    }
                },
                scales: {
                    y: {beginAtZero: true, ticks: {stepSize: 1}},
                    x: {grid: {display: false}}
                },
                plugins: {legend: {display: false}}
            }
        });
    }

    function showMonthDetails(month, books) {
        const monthDetails = document.getElementById('monthDetails');
        const selectedMonth = document.getElementById('selectedMonth');
        const monthBooksList = document.getElementById('monthBooksList');

        selectedMonth.textContent = `Books read in ${month}`;

        if (books.length === 0) {
            monthBooksList.innerHTML = '<p style="text-align: center; color: #666;">No books finished this month.</p>';
        } else {
            monthBooksList.innerHTML = books.map(b => `
                <div class="month-book-card">
                    <div class="book-title">${b.title}</div>
                    <div class="book-author">by ${b.author}</div>
                    <div class="book-rating">‚≠ê ${b.star_rating || 'N/A'} | üå∂Ô∏è ${b.spice_rating || 'N/A'} ${b.pages ? `| üìñ ${b.pages} pages` : ''}</div>
                    ${b.genre ? `<div style="font-size: 0.8em; color: #ff1493;">üìö ${b.genre}</div>` : ''}
                </div>`).join('');
        }

        monthDetails.style.display = 'block';
        monthDetails.scrollIntoView({behavior: 'smooth'});
    }

    if (books && books.length > 0) {
        calculateStats(books);
        createGenreChart(books);
        createPageCategoriesChart(books);
        createStarRatingChart(books);
        createSpiceRatingChart(books);
        createMonthlyChart(books);
    }
</script>
{% endblock %}
